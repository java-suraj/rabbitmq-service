<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>RabbitMQ WebSocket Consumer</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #11998e, #38ef7d);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: #fff;
            width: 100%;
            max-width: 100%;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        h2 {
            color: #222;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .message-count {
            background: #667eea;
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 24px;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 12px;
            margin-bottom: 20px;
            align-items: end;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .status {
            padding: 14px 20px;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-icon {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .connected {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 2px solid #b1dfbb;
        }

        .connected .status-icon {
            background: #28a745;
        }

        .disconnected {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 2px solid #f1b0b7;
        }

        .disconnected .status-icon {
            background: #dc3545;
        }

        label {
            font-weight: 600;
            display: block;
            margin-bottom: 8px;
            color: #444;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 12px 16px;
            font-size: 14px;
            border-radius: 8px;
            border: 2px solid #ddd;
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: #11998e;
            box-shadow: 0 0 0 3px rgba(17, 153, 142, 0.1);
        }

        button {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-connect {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: #fff;
        }

        .btn-disconnect {
            background: linear-gradient(135deg, #eb3349, #f45c43);
            color: #fff;
        }

        .btn-clear {
            background: #f8f9fa;
            color: #666;
            border: 2px solid #dee2e6;
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .messages-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        .messages-table thead {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .messages-table th {
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        .messages-table th:last-child {
            border-right: none;
        }

        .messages-table tbody tr {
            border-bottom: 1px solid #e9ecef;
            animation: slideInRow 0.3s ease-out;
        }

        @keyframes slideInRow {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .messages-table tbody tr:hover {
            background: #f8f9fa;
        }

        .messages-table tbody tr:last-child {
            border-bottom: none;
        }

        .messages-table td {
            padding: 12px;
            font-size: 13px;
            vertical-align: top;
            border-right: 1px solid #e9ecef;
        }

        .messages-table td:last-child {
            border-right: none;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }

        .badge-event {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .payload-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .payload-content {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .payload-item {
            margin: 3px 0;
        }

        .payload-key {
            font-weight: 600;
            color: #495057;
        }

        .payload-value {
            color: #212529;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .cell-id {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #6c757d;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

<div class="container">
    <div class="header">
        <h2>
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
            </svg>
            RabbitMQ WebSocket Consumer
        </h2>
        <span class="message-count" id="messageCount">0 messages</span>
    </div>
    <p class="subtitle">Real-time message monitoring in table format</p>

    <div id="status" class="status disconnected">
        <span class="status-icon"></span>
        Status: Disconnected
    </div>

    <div class="controls">
        <div class="input-group">
            <label for="wsUrl">WebSocket URL</label>
            <input id="wsUrl" type="text" value="ws://localhost:19010/ws/raw/rabbitmq" placeholder="ws://localhost:19010/ws/raw/rabbitmq"/>
        </div>
        <button class="btn-connect" onclick="connect()">Connect</button>
        <button class="btn-disconnect" onclick="disconnect()">Disconnect</button>
        <button class="btn-clear" onclick="clearMessages()">Clear All</button>
    </div>

    <div class="table-container">
        <table class="messages-table" id="messagesTable">
            <thead id="tableHead"></thead>
            <tbody id="tableBody">
                <tr>
                    <td colspan="20" style="text-align: center; padding: 60px 20px; color: #6c757d;">
                        <div style="font-size: 64px; margin-bottom: 16px; opacity: 0.3;">ðŸ“­</div>
                        <h3>No messages yet</h3>
                        <p>Connect to start receiving messages from RabbitMQ</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
let socket = null;
let messageCount = 0;
let messages = [];
let columns = new Set();

const tableHead = document.getElementById("tableHead");
const tableBody = document.getElementById("tableBody");
const statusBox = document.getElementById("status");
const countBox = document.getElementById("messageCount");

function setStatus(connected) {
    if (connected) {
        statusBox.innerHTML = '<span class="status-icon"></span>Status: Connected';
        statusBox.className = "status connected";
    } else {
        statusBox.innerHTML = '<span class="status-icon"></span>Status: Disconnected';
        statusBox.className = "status disconnected";
    }
}

function connect() {
    if (socket) {
        alert("Already connected");
        return;
    }

    const url = document.getElementById("wsUrl").value.trim();

    if (!url.startsWith("ws://") && !url.startsWith("wss://")) {
        alert("Invalid WebSocket URL");
        return;
    }

    socket = new WebSocket(url);

    socket.onopen = () => {
        setStatus(true);
        console.log("WebSocket opened");
    };

    socket.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            
            // Collect all non-null columns
            updateColumns(data);
            
            messages.unshift(data); // Add to beginning
            messageCount++;
            countBox.textContent = `${messageCount} message${messageCount !== 1 ? 's' : ''}`;
            
            renderTable();
        } catch (e) {
            console.error("Failed to parse message:", e);
        }
    };

    socket.onerror = (e) => {
        console.error("WebSocket error:", e);
    };

    socket.onclose = (e) => {
        setStatus(false);
        socket = null;
        console.log(`WebSocket closed (code=${e.code})`);
    };
}

function disconnect() {
    if (!socket) {
        alert("Not connected");
        return;
    }

    socket.close(1000, "Client disconnect");
    socket = null;
}

function clearMessages() {
    messages = [];
    messageCount = 0;
    columns = new Set();
    countBox.textContent = "0 messages";
    tableHead.innerHTML = '';
    tableBody.innerHTML = `
        <tr>
            <td colspan="20" style="text-align: center; padding: 60px 20px; color: #6c757d;">
                <div style="font-size: 64px; margin-bottom: 16px; opacity: 0.3;">ðŸ“­</div>
                <h3>No messages yet</h3>
                <p>Connect to start receiving messages from RabbitMQ</p>
            </td>
        </tr>
    `;
}

function updateColumns(data) {
    // Add all non-null top-level fields
    Object.keys(data).forEach(key => {
        if (data[key] !== null && data[key] !== undefined) {
            columns.add(key);
        }
    });
}

function getColumnOrder() {
    // Define preferred column order
    const order = [
        'eventType',
        'timestamp',
        'source',
        'eventId',
        'version',
        'producerService',
        'userId',
        'group',
        'priority',
        'category',
        'payload',
        'retryCount',
        'correlationId',
        'traceId',
        'spanId',
        'tenantId',
        'expiresAt',
        'headers'
    ];
    
    const ordered = [];
    const remaining = new Set(columns);
    
    // Add in preferred order
    order.forEach(col => {
        if (columns.has(col)) {
            ordered.push(col);
            remaining.delete(col);
        }
    });
    
    // Add any remaining columns
    remaining.forEach(col => ordered.push(col));
    
    return ordered;
}

function renderTable() {
    if (messages.length === 0) {
        tableHead.innerHTML = '';
        tableBody.innerHTML = `
            <tr>
                <td colspan="20" style="text-align: center; padding: 60px 20px; color: #6c757d;">
                    <div style="font-size: 64px; margin-bottom: 16px; opacity: 0.3;">ðŸ“­</div>
                    <h3>No messages yet</h3>
                    <p>Connect to start receiving messages from RabbitMQ</p>
                </td>
            </tr>
        `;
        return;
    }
    
    const orderedColumns = getColumnOrder();
    
    // Render header
    tableHead.innerHTML = `
        <tr>
            <th>#</th>
            ${orderedColumns.map(col => `<th>${formatColumnName(col)}</th>`).join('')}
        </tr>
    `;
    
    // Render rows
    tableBody.innerHTML = messages.map((msg, index) => {
        const rowNumber = messageCount - index;
        return `
            <tr>
                <td style="font-weight: 600; color: #667eea;">${rowNumber}</td>
                ${orderedColumns.map(col => `<td>${formatCell(col, msg[col])}</td>`).join('')}
            </tr>
        `;
    }).join('');
}

function formatColumnName(col) {
    // Convert camelCase to Title Case
    return col.replace(/([A-Z])/g, ' $1')
              .replace(/^./, str => str.toUpperCase());
}

function formatCell(column, value) {
    if (value === null || value === undefined) {
        return '<span style="color: #adb5bd; font-style: italic;">â€”</span>';
    }
    
    switch(column) {
        case 'eventType':
            return `<span class="badge badge-event">${value}</span>`;
            
        case 'timestamp':
        case 'expiresAt':
            return `<span style="white-space: nowrap; font-size: 12px;">${new Date(value * 1000).toLocaleString()}</span>`;
            
        case 'priority':
            const priorityClass = value === 'HIGH' ? 'badge-danger' : 
                                 value === 'MEDIUM' ? 'badge-warning' : 'badge-success';
            return `<span class="badge ${priorityClass}">${value}</span>`;
            
        case 'group':
            return `<span class="badge badge-info">${value}</span>`;
            
        case 'eventId':
        case 'correlationId':
        case 'traceId':
        case 'spanId':
            return `<div class="cell-id" title="${value}">${value}</div>`;
            
        case 'payload':
            if (typeof value === 'object') {
                const items = Object.entries(value)
                    .filter(([_, v]) => v !== null && v !== undefined)
                    .map(([k, v]) => `
                        <div class="payload-item">
                            <span class="payload-key">${k}:</span> 
                            <span class="payload-value">${formatValue(v)}</span>
                        </div>
                    `).join('');
                return `<div class="payload-cell"><div class="payload-content">${items}</div></div>`;
            }
            return formatValue(value);
            
        case 'headers':
            if (typeof value === 'object') {
                const items = Object.entries(value)
                    .map(([k, v]) => `
                        <div class="payload-item">
                            <span class="payload-key">${k}:</span> 
                            <span class="payload-value">${formatValue(v)}</span>
                        </div>
                    `).join('');
                return `<div class="payload-cell"><div class="payload-content">${items}</div></div>`;
            }
            return formatValue(value);
            
        case 'retryCount':
            return `<strong>${value}</strong>`;
            
        default:
            return formatValue(value);
    }
}

function formatValue(value) {
    if (typeof value === 'boolean') {
        return value ? '<span class="badge badge-success">Yes</span>' : '<span class="badge badge-danger">No</span>';
    }
    if (typeof value === 'number') {
        return `<strong>${value}</strong>`;
    }
    if (typeof value === 'object') {
        return `<code style="font-size: 11px;">${JSON.stringify(value)}</code>`;
    }
    return value;
}

window.addEventListener("beforeunload", () => {
    if (socket) socket.close();
});
</script>

</body>
</html>